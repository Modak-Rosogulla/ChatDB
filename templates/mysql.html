<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYSQL RDS Database</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}" />

</head>
<body>
    <div class="container">
        <h2>Your Data in MySQL Database</h2>
        <!-- <div id="json-viewer"></div> -->
        <!-- <button onclick="loadFirebaseData()">Load Firebase Data</button> <input type="text"> -->
        <!-- <div class="button-container">
            <button onclick="refreshDataPreserveState()">Refresh Data (Preserve State)</button>
            <button onclick="refreshDataResetState()">Refresh Data (Reset State)</button>
        </div> -->
        <div class="container">
          <h2>Select a Database</h2>
          <select id="database-select" onchange="selectDatabase()">
              <option value="">Select a database</option>
          </select>

          <form id="mysqlUploadForm" enctype="multipart/form-data">
            <input type="file" name="file" id="fileInput" accept=".csv, .json" required>
            <input type="text" name="table_name" id="tableNameInput" placeholder="Enter table name (optional)">
            <button type="submit">Upload to MySQL</button>
        </form>

      </div>

    </div>

    <div class="container">
        <h2>Chatbot</h2>
        <div class="chat-box" id="chat-box">
            <!-- Messages will appear here -->
        </div>
        
        <div class="input-container">
            <input type="text" id="chat-input" placeholder="Write your SQL query here." />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    
      <script>

            // async function loadSQLData() {
        
            //     try {
            //         const response = await fetch('/mysql_data');
            //         if (!response.ok) {
            //             throw new Error(`Error fetching data: ${response.statusText}`);
            //         }
            //         const data = await response.json();
            //         // const container = document.getElementById('json-viewer');
            //         // createTree(container, data);
            //     } catch (error) {
            //         console.error(error);
            //         // Optionally display an error message in the UI
            //     }
            // }
            async function loadSQLData() {
                  try {
                      const response = await fetch('/mysql_data');
                      if (!response.ok) {
                          throw new Error(`Error fetching data: ${response.statusText}`);
                      }
                      const data = await response.json();

                      // Populate the dropdown
                      const select = document.getElementById('database-select');
                      data.databases.forEach(db => {
                          const option = document.createElement('option');
                          option.value = db;
                          option.textContent = db;
                          select.appendChild(option);
                      });
                  } catch (error) {
                      console.error(error);
                  }
              }
                  
            async function sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
        
                if (message) {
                    addMessageToChat('user', message);
                    input.value = '';
        
                    // Send message to backend
                    const response = await fetch('/chat_sql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });
        
                    if (response.ok) {
                        const data = await response.json();
                        addMessageToChat('bot', data.reply);
                    } else {
                        addMessageToChat('bot', 'Sorry, there was an error.');
                    }
                }
            }
        
            function addMessageToChat(sender, message) {
                const chatBox = document.getElementById('chat-box');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${sender}`;
                messageElement.textContent = message;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            async function selectDatabase() {
              const select = document.getElementById('database-select');
              const databaseName = select.value;

              if (databaseName) {
                  try {
                      const response = await fetch('/select_database', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ database_name: databaseName }),
                      });

                      if (!response.ok) {
                          throw new Error(`Error selecting database: ${response.statusText}`);
                      }

                      const data = await response.json();
                      alert(data.message);
                  } catch (error) {
                      console.error(error);
                  }
                  }
              }

            document.addEventListener('DOMContentLoaded', loadSQLData);


          
        document.getElementById("mysqlUploadForm").onsubmit = async (event) => {
              event.preventDefault();

              const formData = new FormData(event.target);
              const response = await fetch('/upload_to_mysql', {
                  method: 'POST',
                  body: formData
              });

              if (response.ok) {
                  const result = await response.json();
                  alert(result.message);
              } else {
                  const error = await response.json();
                  alert(`Error: ${error.error}`);
              }
          };
        
        </script>
        
</body>
</html>
